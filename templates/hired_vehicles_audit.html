<!-- templates/hired_vehicles_audit.html -->
{% extends "layout.html" %}

{% block content %}
<div class="container">
    <h2>Hired Vehicles Audit</h2>

    <!-- Add Hired Vehicle Form -->
    <div class="glass-card form-card">
        <h3>Register Hired Vehicle</h3>
        <form id="addHiredVehicleForm" method="POST">
            <input type="hidden" name="action" value="add_hired_vehicle">
            <div class="form-row">
                <label>Vehicle Number:</label>
                <input type="text" name="vehicle_no" required placeholder="e.g., KA01AB1234">
            </div>
            <div class="form-row">
                <label>Owner Name:</label>
                <input type="text" name="owner_name" required placeholder="Owner's full name">
            </div>
            <div class="form-row">
                <label>Contact Number:</label>
                <input type="text" name="contact_number" placeholder="Phone number">
            </div>
            <button type="submit" class="submit-btn">Add Hired Vehicle</button>
        </form>
    </div>

    <!-- Add Transaction Form -->
    <div class="glass-card form-card">
        <h3>Add Transaction</h3>
        <form id="addTransactionForm" method="POST">
            <input type="hidden" name="action" value="add_transaction">
            <div class="form-row">
                <label>Hired Vehicle:</label>
                <select name="hired_vehicle_id" required id="hiredVehicleSelect">
                    <option value="">Select Vehicle</option>
                    {% for vehicle in hired_vehicles %}
                    <option value="{{ vehicle.id }}">{{ vehicle.vehicle_no }} - {{ vehicle.owner_name }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="form-row">
                <label>Transaction Type:</label>
                <select name="transaction_type" required id="transactionType">
                    <option value="sale">Sale Made</option>
                    <option value="payment">Payment Given</option>
                </select>
            </div>
            <div class="form-row">
                <label>Date:</label>
                <input type="date" name="transaction_date" required value="{{ today }}">
            </div>
            <div class="form-row">
                <label>Month-Year:</label>
                <input type="month" name="month_year" required value="{{ current_month }}">
            </div>
            <div class="form-row">
                <label>Amount (₹):</label>
                <input type="number" name="amount" step="0.01" required placeholder="0.00">
            </div>
            <div class="form-row">
                <label>Description:</label>
                <input type="text" name="description" placeholder="Transaction details">
            </div>
            <div class="form-row">
                <label>Reference No:</label>
                <input type="text" name="reference_no" placeholder="Bill/Reference number">
            </div>
            <button type="submit" class="submit-btn">Add Transaction</button>
        </form>
    </div>

    <!-- Monthly Report Section -->
    <div class="glass-card">
        <h3>Monthly Audit Report</h3>
        <form id="auditReportForm" class="form-row" style="flex-direction: row; align-items: end; gap: 15px;">
            <div style="flex: 1;">
                <label>Select Month:</label>
                <input type="month" name="report_month" id="reportMonth" value="{{ current_month }}" class="form-control">
            </div>
            <div style="flex: 1;">
                <label>Select Vehicle:</label>
                <select name="hired_vehicle_id" id="reportVehicleSelect" class="form-control">
                    <option value="all">All Vehicles</option>
                    {% for vehicle in hired_vehicles %}
                    <option value="{{ vehicle.id }}">{{ vehicle.vehicle_no }}</option>
                    {% endfor %}
                </select>
            </div>
            <button type="button" onclick="generateAuditReport()" class="submit-btn">Generate Report</button>
            <button type="button" onclick="exportAuditReport()" class="btn-export">Export CSV</button>
        </form>

        <!-- Report Display Area -->
        <div id="auditReportResults" class="mt-4">
            <!-- Report will be loaded here via AJAX -->
        </div>
    </div>

    <!-- Hired Vehicles Summary -->
    <div class="glass-card">
        <h3>Hired Vehicles Summary</h3>
        <div class="dashboard-row">
            {% for summary in hired_vehicles_summary %}
            <div class="card">
                <h4>{{ summary.vehicle_no }}</h4>
                <p>Owner: {{ summary.owner_name }}</p>
                <div style="margin-top: 10px;">
                    <div>Total Sales: ₹{{ "%.2f"|format(summary.total_sales or 0) }}</div>
                    <div>Total Payments: ₹{{ "%.2f"|format(summary.total_payments or 0) }}</div>
                    <div style="font-weight: bold; color: {% if (summary.total_sales or 0) - (summary.total_payments or 0) > 0 %}var(--success){% else %}var(--danger){% endif %};">
                        Balance: ₹{{ "%.2f"|format((summary.total_sales or 0) - (summary.total_payments or 0)) }}
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>

    <!-- Recent Transactions -->
    <div class="glass-card">
        <h3>Recent Transactions</h3>
        <table class="spend-table" id="recentTransactionsTable">
            <thead>
                <tr>
                    <th>Date</th>
                    <th>Vehicle</th>
                    <th>Type</th>
                    <th>Description</th>
                    <th>Amount</th>
                    <th>Reference</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for transaction in recent_transactions %}
                <tr>
                    <td>{{ transaction.transaction_date }}</td>
                    <td>{{ transaction.vehicle_no }}</td>
                    <td>
                        <span class="{% if transaction.transaction_type == 'sale' %}text-success{% else %}text-danger{% endif %}">
                            {{ transaction.transaction_type|title }}
                        </span>
                    </td>
                    <td>{{ transaction.description or '-' }}</td>
                    <td>₹{{ "%.2f"|format(transaction.amount) }}</td>
                    <td>{{ transaction.reference_no or '-' }}</td>
                    <td>
                        <button class="btn-edit btn-sm" onclick="editTransaction({{ transaction.id }})">Edit</button>
                        <button class="btn-delete btn-sm" onclick="deleteTransaction({{ transaction.id }})">Delete</button>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<!-- Edit Transaction Modal -->
<div id="editTransactionModal" class="modal" style="display: none;">
    <div class="modal-content glass-card">
        <span class="close" onclick="closeEditModal()">&times;</span>
        <h3>Edit Transaction</h3>
        <form id="editTransactionForm">
            <input type="hidden" name="transaction_id" id="editTransactionId">
            <div class="form-row">
                <label>Transaction Type:</label>
                <select name="transaction_type" id="editTransactionType" required>
                    <option value="sale">Sale Made</option>
                    <option value="payment">Payment Given</option>
                </select>
            </div>
            <div class="form-row">
                <label>Date:</label>
                <input type="date" name="transaction_date" id="editTransactionDate" required>
            </div>
            <div class="form-row">
                <label>Month-Year:</label>
                <input type="month" name="month_year" id="editMonthYear" required>
            </div>
            <div class="form-row">
                <label>Amount (₹):</label>
                <input type="number" name="amount" id="editAmount" step="0.01" required>
            </div>
            <div class="form-row">
                <label>Description:</label>
                <input type="text" name="description" id="editDescription">
            </div>
            <div class="form-row">
                <label>Reference No:</label>
                <input type="text" name="reference_no" id="editReferenceNo">
            </div>
            <div class="form-row" style="flex-direction: row; gap: 10px;">
                <button type="submit" class="submit-btn">Update</button>
                <button type="button" class="btn-delete" onclick="closeEditModal()">Cancel</button>
            </div>
        </form>
    </div>
</div>

<script>
// Generate audit report
function generateAuditReport() {
    const month = document.getElementById('reportMonth').value;
    const vehicleId = document.getElementById('reportVehicleSelect').value;
    
    fetch(`/api/hired_vehicles_audit?month=${month}&vehicle_id=${vehicleId}`)
        .then(response => response.json())
        .then(data => {
            displayAuditReport(data, month, vehicleId);
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error generating report');
        });
}

// Display audit report
function displayAuditReport(data, month, vehicleId) {
    const resultsDiv = document.getElementById('auditReportResults');
    
    if (data.error) {
        resultsDiv.innerHTML = `<div class="alert alert-error">${data.error}</div>`;
        return;
    }
    
    let html = `<h4>Audit Report for ${month}</h4>`;
    
    if (vehicleId === 'all') {
        // Summary for all vehicles
        html += `<div class="dashboard-row">`;
        data.summary.forEach(vehicle => {
            const balance = (vehicle.total_sales || 0) - (vehicle.total_payments || 0);
            html += `
                <div class="card">
                    <h4>${vehicle.vehicle_no}</h4>
                    <p>${vehicle.owner_name}</p>
                    <div style="margin-top: 10px;">
                        <div>Sales: ₹${(vehicle.total_sales || 0).toFixed(2)}</div>
                        <div>Payments: ₹${(vehicle.total_payments || 0).toFixed(2)}</div>
                        <div style="font-weight: bold; color: ${balance > 0 ? 'var(--success)' : 'var(--danger)'};">
                            Balance: ₹${balance.toFixed(2)}
                        </div>
                    </div>
                </div>
            `;
        });
        html += `</div>`;
    } else {
        // Detailed report for single vehicle
        const vehicle = data.summary[0];
        const balance = (vehicle.total_sales || 0) - (vehicle.total_payments || 0);
        
        html += `
            <div class="glass-card">
                <h4>${vehicle.vehicle_no} - ${vehicle.owner_name}</h4>
                <div class="dashboard-row">
                    <div class="card">
                        <h4>Total Sales</h4>
                        <p>₹${(vehicle.total_sales || 0).toFixed(2)}</p>
                    </div>
                    <div class="card">
                        <h4>Total Payments</h4>
                        <p>₹${(vehicle.total_payments || 0).toFixed(2)}</p>
                    </div>
                    <div class="card">
                        <h4>Net Balance</h4>
                        <p style="color: ${balance > 0 ? 'var(--success)' : 'var(--danger)'};">
                            ₹${balance.toFixed(2)}
                        </p>
                    </div>
                </div>
            </div>
        `;
        
        // Transaction details
        if (data.transactions && data.transactions.length > 0) {
            html += `<div class="glass-card">
                <h4>Transaction Details</h4>
                <table class="spend-table">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Type</th>
                            <th>Description</th>
                            <th>Reference</th>
                            <th>Amount</th>
                        </tr>
                    </thead>
                    <tbody>`;
            
            data.transactions.forEach(trans => {
                html += `
                    <tr>
                        <td>${trans.transaction_date}</td>
                        <td>${trans.transaction_type}</td>
                        <td>${trans.description || '-'}</td>
                        <td>${trans.reference_no || '-'}</td>
                        <td>₹${parseFloat(trans.amount).toFixed(2)}</td>
                    </tr>
                `;
            });
            
            html += `</tbody></table></div>`;
        }
    }
    
    resultsDiv.innerHTML = html;
}

// Export audit report
function exportAuditReport() {
    const month = document.getElementById('reportMonth').value;
    const vehicleId = document.getElementById('reportVehicleSelect').value;
    window.open(`/export/hired_vehicles_audit?month=${month}&vehicle_id=${vehicleId}`, '_blank');
}

// Edit transaction
function editTransaction(transactionId) {
    fetch(`/get_hired_vehicle_transaction/${transactionId}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const trans = data.transaction;
                document.getElementById('editTransactionId').value = trans.id;
                document.getElementById('editTransactionType').value = trans.transaction_type;
                document.getElementById('editTransactionDate').value = trans.transaction_date;
                document.getElementById('editMonthYear').value = trans.month_year;
                document.getElementById('editAmount').value = trans.amount;
                document.getElementById('editDescription').value = trans.description || '';
                document.getElementById('editReferenceNo').value = trans.reference_no || '';
                document.getElementById('editTransactionModal').style.display = 'flex';
            } else {
                alert('Error loading transaction: ' + data.error);
            }
        });
}

// Close edit modal
function closeEditModal() {
    document.getElementById('editTransactionModal').style.display = 'none';
}

// Delete transaction
function deleteTransaction(transactionId) {
    if (confirm('Are you sure you want to delete this transaction?')) {
        fetch(`/delete_hired_vehicle_transaction/${transactionId}`, {
            method: 'DELETE'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('Transaction deleted successfully');
                location.reload();
            } else {
                alert('Error deleting transaction: ' + data.error);
            }
        });
    }
}

// Form submission for edit
document.getElementById('editTransactionForm').addEventListener('submit', function(e) {
    e.preventDefault();
    const formData = new FormData(this);
    
    fetch('/update_hired_vehicle_transaction', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('Transaction updated successfully');
            closeEditModal();
            location.reload();
        } else {
            alert('Error updating transaction: ' + data.error);
        }
    });
});

// Initialize date fields
document.addEventListener('DOMContentLoaded', function() {
    const today = new Date().toISOString().split('T')[0];
    const currentMonth = new Date().toISOString().substring(0, 7);
    
    // Set default values for date fields
    const dateFields = document.querySelectorAll('input[type="date"]');
    dateFields.forEach(field => {
        if (!field.value) field.value = today;
    });
    
    const monthFields = document.querySelectorAll('input[type="month"]');
    monthFields.forEach(field => {
        if (!field.value) field.value = currentMonth;
    });
});
</script>

<style>
.text-success { color: var(--success); }
.text-danger { color: var(--danger); }
.btn-sm { padding: 6px 12px; font-size: 0.8rem; }
.mt-4 { margin-top: 1.5rem; }
</style>
{% endblock %}