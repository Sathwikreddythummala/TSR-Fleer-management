<!-- templates/company_audit.html -->
{% extends "layout.html" %}

{% block content %}
<div class="container">
    <h2>Company Sales & Payments Audit</h2>

    <!-- Quick Stats -->
    <div class="dashboard-row">
        <div class="card">
            <h4>Total Sales</h4>
            <p>‚Çπ{{ "%.2f"|format(totals.total_sales) }}</p>
        </div>
        <div class="card">
            <h4>Total Received</h4>
            <p>‚Çπ{{ "%.2f"|format(totals.total_received) }}</p>
        </div>
        <div class="card">
            <h4>Pending Amount</h4>
            <p style="color: {% if totals.pending_amount > 0 %}var(--warning){% else %}var(--success){% endif %};">
                ‚Çπ{{ "%.2f"|format(totals.pending_amount) }}
            </p>
        </div>
        <div class="card">
            <h4>Companies</h4>
            <p>{{ totals.total_companies }}</p>
        </div>
    </div>

    <!-- Add Sale Form -->
    <div class="glass-card form-card">
        <h3>Record New Sale</h3>
        <form method="POST">
            <input type="hidden" name="action" value="add_sale">
            <div class="form-row">
                <label>Sale Date:</label>
                <input type="date" name="sale_date" required value="{{ today }}">
            </div>
            <div class="form-row">
                <label>Company Name:</label>
                <input type="text" name="company_name" required placeholder="Enter company name">
            </div>
            <div class="form-row">
                <label>Invoice Number:</label>
                <input type="text" name="invoice_number" placeholder="Invoice/Bill number">
            </div>
            <div class="form-row">
                <label>Sale Amount (‚Çπ):</label>
                <input type="number" name="sale_amount" step="0.01" required placeholder="0.00">
            </div>
            <div class="form-row">
                <label>Month-Year:</label>
                <input type="month" name="month_year" required value="{{ current_month }}">
            </div>
            <div class="form-row">
                <label>Description:</label>
                <textarea name="description" placeholder="Sale details, items, etc." rows="3"></textarea>
            </div>
            <button type="submit" class="submit-btn">Record Sale</button>
        </form>
    </div>

    <!-- Add Payment Form -->
    <div class="glass-card form-card">
        <h3>Record Payment Received</h3>
        <form method="POST">
            <input type="hidden" name="action" value="add_payment">
            <div class="form-row">
                <label>Payment Date:</label>
                <input type="date" name="payment_date" required value="{{ today }}">
            </div>
            <div class="form-row">
                <label>Company Name:</label>
                <select name="company_name" required id="companySelect">
                    <option value="">Select Company</option>
                    {% for company in company_list %}
                    <option value="{{ company }}">{{ company }}</option>
                    {% endfor %}
                    <option value="_new">+ Add New Company</option>
                </select>
                <input type="text" name="new_company_name" id="newCompanyInput" style="display: none; margin-top: 5px;" placeholder="Enter new company name">
            </div>
            <div class="form-row">
                <label>Received Amount (‚Çπ):</label>
                <input type="number" name="received_amount" step="0.01" required placeholder="0.00">
            </div>
            <div class="form-row">
                <label>Payment Mode:</label>
                <select name="payment_mode" required>
                    <option value="cash">Cash</option>
                    <option value="bank_transfer">Bank Transfer</option>
                    <option value="upi">UPI</option>
                    <option value="cheque">Cheque</option>
                </select>
            </div>
            <div class="form-row">
                <label>Reference Number:</label>
                <input type="text" name="reference_number" placeholder="Transaction ID, Cheque No., etc.">
            </div>
            <div class="form-row">
                <label>Month-Year:</label>
                <input type="month" name="month_year" required value="{{ current_month }}">
            </div>
            <div class="form-row">
                <label>Description:</label>
                <textarea name="description" placeholder="Payment details" rows="2"></textarea>
            </div>
            <button type="submit" class="submit-btn">Record Payment</button>
        </form>
    </div>

    <!-- Monthly Report Section -->
    <div class="glass-card">
        <h3>Monthly Audit Report</h3>
        <form id="auditReportForm" class="form-row" style="flex-direction: row; align-items: end; gap: 15px;">
            <div style="flex: 1;">
                <label>Select Month:</label>
                <input type="month" name="report_month" id="reportMonth" value="{{ current_month }}" class="form-control">
            </div>
            <div style="flex: 1;">
                <label>Select Company:</label>
                <select name="company_name" id="reportCompanySelect" class="form-control">
                    <option value="all">All Companies</option>
                    {% for company in company_list %}
                    <option value="{{ company }}">{{ company }}</option>
                    {% endfor %}
                </select>
            </div>
            <button type="button" onclick="generateCompanyAuditReport()" class="submit-btn">Generate Report</button>
            <button type="button" onclick="exportCompanyAuditReport()" class="btn-export">Export CSV</button>
        </form>

        <!-- Report Display Area -->
        <div id="companyAuditReportResults" class="mt-4">
            <!-- Report will be loaded here via AJAX -->
        </div>
    </div>

    <!-- Company-wise Summary -->
    <div class="glass-card">
        <h3>Company-wise Summary</h3>
        <div class="search-container">
            <i class="search-icon">üîç</i>
            <input type="text" id="companySearch" class="search-box" placeholder="Search companies..." onkeyup="filterCompanies()">
        </div>
        <table class="spend-table" id="companySummaryTable">
            <thead>
                <tr>
                    <th>Company Name</th>
                    <th>Total Sales</th>
                    <th>Total Received</th>
                    <th>Pending Amount</th>
                    <th>Last Sale</th>
                    <th>Last Payment</th>
                </tr>
            </thead>
            <tbody>
                {% for company in company_summary %}
                <tr>
                    <td><strong>{{ company.company_name }}</strong></td>
                    <td>‚Çπ{{ "%.2f"|format(company.total_sales) }}</td>
                    <td>‚Çπ{{ "%.2f"|format(company.total_received) }}</td>
                    <td style="color: {% if company.pending_amount > 0 %}var(--warning){% else %}var(--success){% endif %}; font-weight: bold;">
                        ‚Çπ{{ "%.2f"|format(company.pending_amount) }}
                    </td>
                    <td>{{ company.last_sale_date or '-' }}</td>
                    <td>{{ company.last_payment_date or '-' }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- Recent Activity -->
    <div class="glass-card">
        <h3>Recent Activity</h3>
        <div class="tabs">
            <div class="tab active" onclick="switchCompanyTab('recentSales')">Recent Sales</div>
            <div class="tab" onclick="switchCompanyTab('recentPayments')">Recent Payments</div>
        </div>

        <div id="recentSales" class="tab-content active">
            <table class="spend-table">
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Company</th>
                        <th>Invoice</th>
                        <th>Amount</th>
                        <th>Description</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for sale in recent_sales %}
                    <tr>
                        <td>{{ sale.sale_date }}</td>
                        <td>{{ sale.company_name }}</td>
                        <td>{{ sale.invoice_number or '-' }}</td>
                        <td>‚Çπ{{ "%.2f"|format(sale.sale_amount) }}</td>
                        <td>{{ sale.description or '-' }}</td>
                        <td>
                            <button class="btn-edit btn-sm" onclick="editSale({{ sale.id }})">Edit</button>
                            <button class="btn-delete btn-sm" onclick="deleteSale({{ sale.id }})">Delete</button>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <div id="recentPayments" class="tab-content">
            <table class="spend-table">
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Company</th>
                        <th>Amount</th>
                        <th>Mode</th>
                        <th>Reference</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for payment in recent_payments %}
                    <tr>
                        <td>{{ payment.payment_date }}</td>
                        <td>{{ payment.company_name }}</td>
                        <td>‚Çπ{{ "%.2f"|format(payment.received_amount) }}</td>
                        <td>{{ payment.payment_mode|title }}</td>
                        <td>{{ payment.reference_number or '-' }}</td>
                        <td>
                            <button class="btn-edit btn-sm" onclick="editPayment({{ payment.id }})">Edit</button>
                            <button class="btn-delete btn-sm" onclick="deletePayment({{ payment.id }})">Delete</button>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Edit Sale Modal -->
<div id="editSaleModal" class="modal" style="display: none;">
    <div class="modal-content glass-card">
        <span class="close" onclick="closeEditSaleModal()">&times;</span>
        <h3>Edit Sale</h3>
        <form id="editSaleForm">
            <input type="hidden" name="sale_id" id="editSaleId">
            <div class="form-row">
                <label>Sale Date:</label>
                <input type="date" name="sale_date" id="editSaleDate" required>
            </div>
            <div class="form-row">
                <label>Company Name:</label>
                <input type="text" name="company_name" id="editCompanyName" required>
            </div>
            <div class="form-row">
                <label>Invoice Number:</label>
                <input type="text" name="invoice_number" id="editInvoiceNumber">
            </div>
            <div class="form-row">
                <label>Sale Amount (‚Çπ):</label>
                <input type="number" name="sale_amount" id="editSaleAmount" step="0.01" required>
            </div>
            <div class="form-row">
                <label>Month-Year:</label>
                <input type="month" name="month_year" id="editSaleMonthYear" required>
            </div>
            <div class="form-row">
                <label>Description:</label>
                <textarea name="description" id="editSaleDescription" rows="3"></textarea>
            </div>
            <div class="form-row" style="flex-direction: row; gap: 10px;">
                <button type="submit" class="submit-btn">Update Sale</button>
                <button type="button" class="btn-delete" onclick="closeEditSaleModal()">Cancel</button>
            </div>
        </form>
    </div>
</div>

<!-- Edit Payment Modal -->
<div id="editPaymentModal" class="modal" style="display: none;">
    <div class="modal-content glass-card">
        <span class="close" onclick="closeEditPaymentModal()">&times;</span>
        <h3>Edit Payment</h3>
        <form id="editPaymentForm">
            <input type="hidden" name="payment_id" id="editPaymentId">
            <div class="form-row">
                <label>Payment Date:</label>
                <input type="date" name="payment_date" id="editPaymentDate" required>
            </div>
            <div class="form-row">
                <label>Company Name:</label>
                <input type="text" name="company_name" id="editPaymentCompanyName" required>
            </div>
            <div class="form-row">
                <label>Received Amount (‚Çπ):</label>
                <input type="number" name="received_amount" id="editReceivedAmount" step="0.01" required>
            </div>
            <div class="form-row">
                <label>Payment Mode:</label>
                <select name="payment_mode" id="editPaymentMode" required>
                    <option value="cash">Cash</option>
                    <option value="bank_transfer">Bank Transfer</option>
                    <option value="upi">UPI</option>
                    <option value="cheque">Cheque</option>
                </select>
            </div>
            <div class="form-row">
                <label>Reference Number:</label>
                <input type="text" name="reference_number" id="editReferenceNumber">
            </div>
            <div class="form-row">
                <label>Month-Year:</label>
                <input type="month" name="month_year" id="editPaymentMonthYear" required>
            </div>
            <div class="form-row">
                <label>Description:</label>
                <textarea name="description" id="editPaymentDescription" rows="2"></textarea>
            </div>
            <div class="form-row" style="flex-direction: row; gap: 10px;">
                <button type="submit" class="submit-btn">Update Payment</button>
                <button type="button" class="btn-delete" onclick="closeEditPaymentModal()">Cancel</button>
            </div>
        </form>
    </div>
</div>

<script>
// Company selection handling
document.getElementById('companySelect').addEventListener('change', function() {
    const newCompanyInput = document.getElementById('newCompanyInput');
    if (this.value === '_new') {
        newCompanyInput.style.display = 'block';
        newCompanyInput.required = true;
    } else {
        newCompanyInput.style.display = 'none';
        newCompanyInput.required = false;
    }
});

// Tab switching
function switchCompanyTab(tabName) {
    document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
    document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
    
    document.getElementById(tabName).classList.add('active');
    event.target.classList.add('active');
}

// Generate company audit report
function generateCompanyAuditReport() {
    const month = document.getElementById('reportMonth').value;
    const company = document.getElementById('reportCompanySelect').value;
    
    fetch(`/api/company_audit?month=${month}&company=${company}`)
        .then(response => response.json())
        .then(data => {
            displayCompanyAuditReport(data, month, company);
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error generating report');
        });
}

// Display company audit report
function displayCompanyAuditReport(data, month, company) {
    const resultsDiv = document.getElementById('companyAuditReportResults');
    
    if (data.error) {
        resultsDiv.innerHTML = `<div class="alert alert-error">${data.error}</div>`;
        return;
    }
    
    let html = `<h4>Company Audit Report for ${month}</h4>`;
    
    if (company === 'all') {
        // Summary for all companies
        html += `<div class="glass-card">
            <h5>Overall Summary</h5>
            <div class="dashboard-row">
                <div class="card">
                    <h6>Total Sales</h6>
                    <p>‚Çπ${data.totals.total_sales.toFixed(2)}</p>
                </div>
                <div class="card">
                    <h6>Total Received</h6>
                    <p>‚Çπ${data.totals.total_received.toFixed(2)}</p>
                </div>
                <div class="card">
                    <h6>Pending</h6>
                    <p style="color: ${data.totals.pending_amount > 0 ? 'var(--warning)' : 'var(--success)'};">
                        ‚Çπ${data.totals.pending_amount.toFixed(2)}
                    </p>
                </div>
            </div>
        </div>`;
        
        // Company-wise breakdown
        html += `<div class="glass-card">
            <h5>Company-wise Breakdown</h5>
            <table class="spend-table">
                <thead>
                    <tr>
                        <th>Company</th>
                        <th>Sales</th>
                        <th>Received</th>
                        <th>Pending</th>
                    </tr>
                </thead>
                <tbody>`;
        
        data.companies.forEach(comp => {
            html += `
                <tr>
                    <td><strong>${comp.company_name}</strong></td>
                    <td>‚Çπ${comp.sales_amount.toFixed(2)}</td>
                    <td>‚Çπ${comp.received_amount.toFixed(2)}</td>
                    <td style="color: ${comp.pending_amount > 0 ? 'var(--warning)' : 'var(--success)'};">
                        ‚Çπ${comp.pending_amount.toFixed(2)}
                    </td>
                </tr>
            `;
        });
        
        html += `</tbody></table></div>`;
        
    } else {
        // Detailed report for single company
        const companyData = data.companies[0];
        
        html += `
            <div class="glass-card">
                <h5>${companyData.company_name} - Detailed Report</h5>
                <div class="dashboard-row">
                    <div class="card">
                        <h6>Total Sales</h6>
                        <p>‚Çπ${companyData.sales_amount.toFixed(2)}</p>
                    </div>
                    <div class="card">
                        <h6>Total Received</h6>
                        <p>‚Çπ${companyData.received_amount.toFixed(2)}</p>
                    </div>
                    <div class="card">
                        <h6>Pending Amount</h6>
                        <p style="color: ${companyData.pending_amount > 0 ? 'var(--warning)' : 'var(--success)'};">
                            ‚Çπ${companyData.pending_amount.toFixed(2)}
                        </p>
                    </div>
                </div>
            </div>`;
        
        // Transaction details
        if (data.transactions && data.transactions.length > 0) {
            html += `<div class="glass-card">
                <h5>Transaction Details</h5>
                <table class="spend-table">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Type</th>
                            <th>Reference</th>
                            <th>Amount</th>
                            <th>Payment Mode</th>
                            <th>Description</th>
                        </tr>
                    </thead>
                    <tbody>`;
            
            data.transactions.forEach(trans => {
                html += `
                    <tr>
                        <td>${trans.date}</td>
                        <td>
                            <span class="${trans.type === 'sale' ? 'text-success' : 'text-danger'}">
                                ${trans.type.toUpperCase()}
                            </span>
                        </td>
                        <td>${trans.reference || '-'}</td>
                        <td>‚Çπ${parseFloat(trans.amount).toFixed(2)}</td>
                        <td>${trans.payment_mode ? trans.payment_mode.replace('_', ' ').toUpperCase() : '-'}</td>
                        <td>${trans.description || '-'}</td>
                    </tr>
                `;
            });
            
            html += `</tbody></table></div>`;
        } else {
            html += `<div class="glass-card">
                <p>No transactions found for ${companyData.company_name} in ${month}</p>
            </div>`;
        }
    }
    
    resultsDiv.innerHTML = html;
}

// Export company audit report
function exportCompanyAuditReport() {
    const month = document.getElementById('reportMonth').value;
    const company = document.getElementById('reportCompanySelect').value;
    window.open(`/export/company_audit?month=${month}&company=${company}`, '_blank');
}

// Filter companies in summary table
function filterCompanies() {
    const input = document.getElementById('companySearch');
    const filter = input.value.toLowerCase();
    const table = document.getElementById('companySummaryTable');
    const rows = table.getElementsByTagName('tbody')[0].getElementsByTagName('tr');
    
    for (let i = 0; i < rows.length; i++) {
        const companyName = rows[i].getElementsByTagName('td')[0].textContent.toLowerCase();
        if (companyName.indexOf(filter) > -1) {
            rows[i].style.display = '';
        } else {
            rows[i].style.display = 'none';
        }
    }
}

// Edit sale
function editSale(saleId) {
    fetch(`/get_company_sale/${saleId}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const sale = data.sale;
                document.getElementById('editSaleId').value = sale.id;
                document.getElementById('editSaleDate').value = sale.sale_date;
                document.getElementById('editCompanyName').value = sale.company_name;
                document.getElementById('editInvoiceNumber').value = sale.invoice_number;
                document.getElementById('editSaleAmount').value = sale.sale_amount;
                document.getElementById('editSaleMonthYear').value = sale.month_year;
                document.getElementById('editSaleDescription').value = sale.description;
                document.getElementById('editSaleModal').style.display = 'flex';
            } else {
                alert('Error loading sale: ' + data.error);
            }
        });
}

// Close edit sale modal
function closeEditSaleModal() {
    document.getElementById('editSaleModal').style.display = 'none';
}

// Edit payment
function editPayment(paymentId) {
    fetch(`/get_company_payment/${paymentId}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const payment = data.payment;
                document.getElementById('editPaymentId').value = payment.id;
                document.getElementById('editPaymentDate').value = payment.payment_date;
                document.getElementById('editPaymentCompanyName').value = payment.company_name;
                document.getElementById('editReceivedAmount').value = payment.received_amount;
                document.getElementById('editPaymentMode').value = payment.payment_mode;
                document.getElementById('editReferenceNumber').value = payment.reference_number;
                document.getElementById('editPaymentMonthYear').value = payment.month_year;
                document.getElementById('editPaymentDescription').value = payment.description;
                document.getElementById('editPaymentModal').style.display = 'flex';
            } else {
                alert('Error loading payment: ' + data.error);
            }
        });
}

// Close edit payment modal
function closeEditPaymentModal() {
    document.getElementById('editPaymentModal').style.display = 'none';
}

// Delete sale
function deleteSale(saleId) {
    if (confirm('Are you sure you want to delete this sale record?')) {
        fetch(`/delete_company_sale/${saleId}`, {
            method: 'DELETE'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('Sale deleted successfully');
                location.reload();
            } else {
                alert('Error deleting sale: ' + data.error);
            }
        });
    }
}

// Delete payment
function deletePayment(paymentId) {
    if (confirm('Are you sure you want to delete this payment record?')) {
        fetch(`/delete_company_payment/${paymentId}`, {
            method: 'DELETE'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('Payment deleted successfully');
                location.reload();
            } else {
                alert('Error deleting payment: ' + data.error);
            }
        });
    }
}

// Form submission for edit sale
document.getElementById('editSaleForm').addEventListener('submit', function(e) {
    e.preventDefault();
    const formData = new FormData(this);
    
    fetch('/update_company_sale', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('Sale updated successfully');
            closeEditSaleModal();
            location.reload();
        } else {
            alert('Error updating sale: ' + data.error);
        }
    });
});

// Form submission for edit payment
document.getElementById('editPaymentForm').addEventListener('submit', function(e) {
    e.preventDefault();
    const formData = new FormData(this);
    
    fetch('/update_company_payment', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('Payment updated successfully');
            closeEditPaymentModal();
            location.reload();
        } else {
            alert('Error updating payment: ' + data.error);
        }
    });
});

// Initialize date fields
document.addEventListener('DOMContentLoaded', function() {
    const today = new Date().toISOString().split('T')[0];
    const currentMonth = new Date().toISOString().substring(0, 7);
    
    // Set default values for date fields if not already set
    const dateFields = document.querySelectorAll('input[type="date"]');
    dateFields.forEach(field => {
        if (!field.value) field.value = today;
    });
    
    const monthFields = document.querySelectorAll('input[type="month"]');
    monthFields.forEach(field => {
        if (!field.value) field.value = currentMonth;
    });
});
</script>

<style>
.text-success { color: var(--success); }
.text-danger { color: var(--danger); }
.btn-sm { padding: 6px 12px; font-size: 0.8rem; }
.mt-4 { margin-top: 1.5rem; }
.form-control { 
    padding: 10px 12px;
    border-radius: 8px;
    border: var(--border);
    background: rgba(255, 255, 255, 0.2);
    color: white;
    width: 100%;
}
</style>
{% endblock %}