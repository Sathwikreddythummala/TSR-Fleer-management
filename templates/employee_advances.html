<!-- templates/employee_advances.html -->
{% extends "layout.html" %}
{% block content %}
<h2>Employee Advances & Expenses Management</h2>

<!-- Initialize variables to prevent errors -->
{% set advances = advances or [] %}
{% set employee_spendings = employee_spendings or [] %}
{% set employee_balances = employee_balances or [] %}
{% set today = today or now.strftime('%Y-%m-%d') %}

<!-- Edit Advance Modal -->
<div id="editAdvanceModal" class="modal">
    <div class="modal-content">
        <span class="close">&times;</span>
        <h3>Edit Employee Advance</h3>
        <form id="editAdvanceForm">
            <input type="hidden" id="edit_advance_id" name="id">
            <label>
                Employee Name:
                <input type="text" id="edit_employee_name" name="employee_name" required>
            </label>
            <label>
                Date:
                <input type="date" id="edit_date" name="date" required>
            </label>
            <label>
                Amount (₹):
                <input type="number" id="edit_amount" name="amount" step="0.01" required>
            </label>
            <label>
                Purpose:
                <input type="text" id="edit_purpose" name="purpose" placeholder="Optional">
            </label>
            <div class="form-buttons">
                <button type="submit" class="btn-primary">Update Advance</button>
                <button type="button" id="deleteAdvanceBtn" class="btn-danger">Delete Advance</button>
                <button type="button" class="btn-secondary" onclick="closeEditModal()">Cancel</button>
            </div>
        </form>
    </div>
</div>

<div class="grid-2-col">
    <!-- Add Advance Form -->
    <div class="glass-card form-card">
        <h3>Add Employee Advance</h3>
        <form method="POST" action="{{ url_for('employee_advances') }}">
            <input type="hidden" name="form_type" value="advance">
            <label>
                Employee Name:
                <input type="text" name="employee_name" required>
            </label>
            <label>
                Date:
                <input type="date" name="date" required value="{{ today }}">
            </label>
            <label>
                Amount (₹):
                <input type="number" name="amount" step="0.01" required>
            </label>
            <label>
                Purpose:
                <input type="text" name="purpose" placeholder="Optional">
            </label>
            <button type="submit" class="btn-primary">Add Advance</button>
        </form>
    </div>

    <!-- Add Expense Info -->
    <div class="glass-card form-card">
        <h3>Employee Expenses</h3>
        <div style="padding: 20px;">
            <p><strong>Employee expenses are recorded in the Spendings section.</strong></p>
            <p>To add employee expenses:</p>
            <ol style="text-align: left; margin: 15px 0;">
                <li>Go to <strong>Spendings</strong> page</li>
                <li>Fill the spending details</li>
                <li>Select employee name in <strong>"Spended By"</strong> field</li>
            </ol>
            <a href="{{ url_for('spendings') }}" class="btn-primary" style="display: inline-block; margin-top: 10px;">
                Go to Spendings Page
            </a>
        </div>
    </div>
</div>

<!-- Employee Balances Summary -->
<!-- Employee Balances Summary -->
<div class="glass-card">
    <h3>Employee Balances Summary</h3>
    {% if employee_balances %}
    <table class="spend-table">
        <thead>
            <tr>
                <th>Employee Name</th>
                <th>Total Advances (₹)</th>
                <th>Total Expenses (₹)</th>
                <th>Balance (₹)</th>
                <th>Status</th>
            </tr>
        </thead>
        <tbody>
            {% for emp in employee_balances %}
            {% set advances = emp.total_advances|float %}
            {% set expenses = emp.total_expenses|float %}
            {% set balance = advances - expenses %}
            <tr>
                <td><strong>{{ emp.employee_name }}</strong></td>
                <td>₹{{ "%.2f"|format(advances) }}</td>
                <td>₹{{ "%.2f"|format(expenses) }}</td>
                <td class="{% if balance > 0 %}positive-balance{% elif balance < 0 %}negative-balance{% else %}zero-balance{% endif %}">
                    ₹{{ "%.2f"|format(balance) }}
                </td>
                <td>
                    {% if balance > 0 %}
                        <span class="status-owed">Employee owes company</span>
                    {% elif balance < 0 %}
                        <span class="status-owing">Company owes employee</span>
                    {% else %}
                        <span class="status-settled">Settled</span>
                    {% endif %}
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% else %}
    <div style="text-align: center; padding: 20px; color: #666;">
        <p>No employee balance data available.</p>
    </div>
    {% endif %}
</div>

<!-- Recent Advances with Edit Buttons -->
<div class="glass-card">
    <h3>Recent Advances</h3>
    {% if advances %}
    <table class="spend-table">
        <thead>
            <tr>
                <th>Date</th>
                <th>Employee Name</th>
                <th>Amount (₹)</th>
                <th>Purpose</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for advance in advances %}
            <tr>
                <td>{{ advance.date }}</td>
                <td><strong>{{ advance.employee_name }}</strong></td>
                <td>₹{{ "%.2f"|format(advance.amount|float) }}</td>
                <td>{{ advance.purpose or '-' }}</td>
                <td>
                    <button class="btn-edit" onclick="editAdvance({{ advance.id }})">Edit</button>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% else %}
    <div style="text-align: center; padding: 20px; color: #666;">
        <p>No advances recorded yet.</p>
    </div>
    {% endif %}
</div>

<div class="glass-card">
    <h3>Quick Summary</h3>
    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-number">{{ employee_balances|length }}</div>
            <div class="stat-label">Employees</div>
        </div>
        <div class="stat-card">
            <div class="stat-number">₹{{ "%.2f"|format(employee_balances|sum(attribute='total_advances')|float) }}</div>
            <div class="stat-label">Total Advances</div>
        </div>
        <div class="stat-card">
            <div class="stat-number">₹{{ "%.2f"|format(employee_balances|sum(attribute='total_expenses')|float) }}</div>
            <div class="stat-label">Total Expenses</div>
        </div>
        <div class="stat-card">
            <div class="stat-number">₹{{ "%.2f"|format(employee_balances|sum(attribute='balance')|float) }}</div>
            <div class="stat-label">Net Balance</div>
        </div>
    </div>
</div>

<!-- Employee Expenses from Spendings -->
<div class="glass-card">
    <h3>Employee Expenses (From Spendings)</h3>
    {% if employee_spendings %}
    <table class="spend-table">
        <thead>
            <tr>
                <th>Date</th>
                <th>Employee</th>
                <th>Amount (₹)</th>
                <th>Vehicle</th>
                <th>Category</th>
                <th>Purpose</th>
            </tr>
        </thead>
        <tbody>
            {% for spending in employee_spendings %}
            <tr>
                <td>{{ spending.date }}</td>
                <td><strong>{{ spending.employee_name }}</strong></td>
                <td>₹{{ "%.2f"|format(spending.amount|float) }}</td>
                <td>{{ spending.vehicle_no or '-' }}</td>
                <td><span class="category-badge">{{ spending.category or '-' }}</span></td>
                <td>{{ spending.purpose or '-' }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% else %}
    <div style="text-align: center; padding: 20px; color: #666;">
        <p>No employee expenses recorded yet.</p>
        <p><small>Expenses are recorded when "Spended By" field is filled in Spendings</small></p>
    </div>
    {% endif %}
</div>

<!-- Quick Stats -->


<style>
.grid-2-col {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 20px;
    margin-bottom: 20px;
}

@media (max-width: 768px) {
    .grid-2-col {
        grid-template-columns: 1fr;
    }
}

.glass-card {
    margin-bottom: 20px;
    padding: 20px;
    background: rgba(255, 255, 255, 0.1);
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
    border-radius: 16px;
    border: 1px solid rgba(255, 255, 255, 0.18);
    box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37);
    transition: transform 0.3s ease, box-shadow 0.3s ease;
}

.glass-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 12px 40px 0 rgba(31, 38, 135, 0.5);
}

.form-card {
    background: rgba(255, 255, 255, 0.1);
    border-radius: 10px;
}

.form-card label {
    display: block;
    margin-bottom: 15px;
    font-weight: 500;
}

.form-card input {
    width: 100%;
    padding: 10px;
    margin-top: 5px;
    border: 1px solid #ddd;
    border-radius: 5px;
    font-size: 14px;
}

.btn-primary {
    width: 100%;
    padding: 12px;
    background-color: #007bff;
    color: white;
    border: none;
    border-radius: 5px;
    cursor: pointer;
    font-size: 16px;
    font-weight: 500;
    text-decoration: none;
    display: inline-block;
    text-align: center;
}

.btn-primary:hover {
    background-color: #0056b3;
}

.positive-balance {
    color: #28a745;
    font-weight: bold;
    font-size: 1.1em;
}

.negative-balance {
    color: #dc3545;
    font-weight: bold;
    font-size: 1.1em;
}

.zero-balance {
    color: #6c757d;
    font-weight: bold;
}

.status-owed {
    background-color: #d4edda;
    color: #155724;
    padding: 4px 8px;
    border-radius: 4px;
    font-size: 0.8em;
    font-weight: 500;
}

.status-owing {
    background-color: #f8d7da;
    color: #721c24;
    padding: 4px 8px;
    border-radius: 4px;
    font-size: 0.8em;
    font-weight: 500;
}

.status-settled {
    background-color: #e2e3e5;
    color: #383d41;
    padding: 4px 8px;
    border-radius: 4px;
    font-size: 0.8em;
    font-weight: 500;
}

.spend-table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 10px;
}

.spend-table th {
    background-color: #298bed;
    padding: 12px;
    text-align: left;
    font-weight: 600;
    border-bottom: 2px solid #dee2e6;
}

.spend-table td {
    padding: 12px;
    border-bottom: 1px solid #dee2e6;
}

.spend-table tr:hover {
    background-color: #f8f9fa;
}

.category-badge {
    background-color: #e9ecef;
    padding: 4px 8px;
    border-radius: 4px;
    font-size: 0.8em;
    color: #495057;
}

.stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 15px;
    margin-top: 15px;
}

.stat-card {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 20px;
    border-radius: 10px;
    text-align: center;
}

.stat-number {
    font-size: 2em;
    font-weight: bold;
    margin-bottom: 5px;
}

.stat-label {
    font-size: 0.9em;
    opacity: 0.9;
}

/* Modal Styles */
.modal {
    display: none;
    position: fixed;
    z-index: 1000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0,0,0,0.5);
}

.modal-content {
    background-color: white;
    margin: 5% auto;
    padding: 30px;
    border-radius: 10px;
    width: 90%;
    max-width: 500px;
    box-shadow: 0 5px 15px rgba(0,0,0,0.3);
}

.close {
    float: right;
    font-size: 28px;
    font-weight: bold;
    cursor: pointer;
    color: #aaa;
}

.close:hover {
    color: #000;
}

.form-buttons {
    display: flex;
    gap: 10px;
    margin-top: 20px;
    flex-wrap: wrap;
}

.btn-edit {
    background-color: #ffc107;
    color: black;
    border: none;
    padding: 6px 12px;
    border-radius: 4px;
    cursor: pointer;
    font-size: 0.9em;
}

.btn-edit:hover {
    background-color: #e0a800;
}

.btn-danger {
    background-color: #dc3545;
    color: white;
    border: none;
    padding: 10px 15px;
    border-radius: 5px;
    cursor: pointer;
    flex: 1;
}

.btn-danger:hover {
    background-color: #c82333;
}

.btn-secondary {
    background-color: #6c757d;
    color: white;
    border: none;
    padding: 10px 15px;
    border-radius: 5px;
    cursor: pointer;
    flex: 1;
}

.btn-secondary:hover {
    background-color: #545b62;
}

/* Responsive design */
@media (max-width: 768px) {
    .glass-card {
        padding: 15px;
    }
    
    .stats-grid {
        grid-template-columns: 1fr 1fr;
    }
    
    .spend-table {
        font-size: 0.9em;
    }
    
    .spend-table th,
    .spend-table td {
        padding: 8px;
    }
    
    .modal-content {
        width: 95%;
        margin: 10% auto;
        padding: 20px;
    }
    
    .form-buttons {
        flex-direction: column;
    }
}

/* Flash message styling */
.flash-messages {
    margin-bottom: 20px;
}

.flash-message {
    padding: 10px 15px;
    border-radius: 5px;
    margin-bottom: 10px;
}

.flash-success {
    background-color: #d4edda;
    color: #155724;
    border: 1px solid #c3e6cb;
}

.flash-error {
    background-color: #f8d7da;
    color: #721c24;
    border: 1px solid #f5c6cb;
}

.flash-info {
    background-color: #cce7ff;
    color: #004085;
    border: 1px solid #b3d7ff;
}
</style>

<script>
// Edit Advance Functionality
function editAdvance(advanceId) {
    fetch(`/get_employee_advance/${advanceId}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const advance = data.advance;
                document.getElementById('edit_advance_id').value = advance.id;
                document.getElementById('edit_employee_name').value = advance.employee_name;
                document.getElementById('edit_date').value = advance.date;
                document.getElementById('edit_amount').value = advance.amount;
                document.getElementById('edit_purpose').value = advance.purpose || '';
                
                document.getElementById('editAdvanceModal').style.display = 'block';
            } else {
                alert('Error loading advance: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error loading advance details');
        });
}

function closeEditModal() {
    document.getElementById('editAdvanceModal').style.display = 'none';
}

// Close modal when clicking X
document.querySelector('.close').onclick = closeEditModal;

// Submit edit form
document.getElementById('editAdvanceForm').onsubmit = function(e) {
    e.preventDefault();
    
    const formData = new FormData(this);
    const advanceId = document.getElementById('edit_advance_id').value;
    
    fetch(`/edit_employee_advance/${advanceId}`, {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(data.message);
            closeEditModal();
            location.reload(); // Refresh page to show changes
        } else {
            alert('Error: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error updating advance');
    });
}

// Delete advance
document.getElementById('deleteAdvanceBtn').onclick = function() {
    if (confirm('Are you sure you want to delete this advance? This action cannot be undone.')) {
        const advanceId = document.getElementById('edit_advance_id').value;
        
        fetch(`/delete_employee_advance/${advanceId}`, {
            method: 'DELETE'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert(data.message);
                closeEditModal();
                location.reload();
            } else {
                alert('Error: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error deleting advance');
        });
    }
}

// Close modal when clicking outside
window.onclick = function(event) {
    const modal = document.getElementById('editAdvanceModal');
    if (event.target == modal) {
        closeEditModal();
    }
}

// Auto-hide flash messages after 5 seconds
document.addEventListener('DOMContentLoaded', function() {
    const flashMessages = document.querySelectorAll('.flash-message');
    flashMessages.forEach(message => {
        setTimeout(() => {
            message.style.transition = 'opacity 0.5s ease';
            message.style.opacity = '0';
            setTimeout(() => message.remove(), 500);
        }, 5000);
    });
    
    // Add current date if not set
    const dateInputs = document.querySelectorAll('input[type="date"]');
    const today = new Date().toISOString().split('T')[0];
    dateInputs.forEach(input => {
        if (!input.value) {
            input.value = today;
        }
    });
});
</script>
{% endblock %}